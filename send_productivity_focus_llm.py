#!/usr/bin/env python3
"""
Productivity Focus Rich Message with LLM-Generated Content

This script uses the productivity_focus_01.png template and generates
content using our Azure OpenAI LLM for personalized focus strategies.
"""

import sys
import os
from datetime import datetime

# Add src to path
sys.path.append('/home/runner/workspace/src')

def generate_focus_content_with_llm(openai_service):
    """Generate productivity focus content using LLM"""
    
    # Create a focused prompt for productivity content
    prompt = """Create inspiring productivity and focus content for a LINE message. The content should be:

Theme: Deep work and concentration
Mood: Focused and energetic  
Purpose: Help someone achieve better focus and productivity today

Please provide:
1. A compelling title (max 30 characters, include an emoji)
2. Main inspirational message about focus/productivity (2-3 sentences)
3. One practical focus tip they can implement immediately
4. A motivating call-to-action

Keep it concise, actionable, and inspiring. Focus on deep work, concentration, and achieving goals through better attention management."""

    try:
        # Generate content using our OpenAI service
        response = openai_service.generate_response("productivity_focus_user", prompt)
        
        if response and response.strip():
            return response.strip()
        else:
            # Fallback if LLM doesn't respond
            return None
    except Exception as e:
        print(f"âš ï¸ LLM generation failed: {str(e)}")
        return None

def parse_llm_content(llm_response):
    """Parse LLM response into structured content"""
    
    if not llm_response:
        return None
    
    # Try to extract title and content from LLM response
    lines = [line.strip() for line in llm_response.split('\n') if line.strip()]
    
    if len(lines) >= 2:
        # First line is usually the title
        title = lines[0]
        # Remove common prefixes
        if title.startswith('Title:') or title.startswith('1.'):
            title = title.split(':', 1)[-1].strip()
            if title.startswith(' '):
                title = title[1:]
        
        # Rest is content
        content = ' '.join(lines[1:])
        
        # Clean up content
        content = content.replace('2.', '').replace('3.', '').replace('4.', '')
        content = content.replace('Main message:', '').replace('Tip:', '').replace('Call-to-action:', '')
        content = content.strip()
        
        return {
            'title': title,
            'content': content
        }
    else:
        # Single block of text - use first sentence as title
        sentences = llm_response.split('.')
        if len(sentences) >= 2:
            return {
                'title': sentences[0].strip() + '.',
                'content': '.'.join(sentences[1:]).strip()
            }
    
    # Fallback - use entire response as content
    return {
        'title': 'ğŸ¯ Focus Power',
        'content': llm_response
    }

def send_productivity_focus_message(user_id):
    """Send productivity focus message with LLM-generated content"""
    
    print("ğŸ¯ PRODUCTIVITY FOCUS RICH MESSAGE WITH LLM")
    print("=" * 45)
    print(f"ğŸ“± Target: {user_id}")
    print("ğŸ¨ Template: productivity_focus_01.png")
    print("ğŸ¤– Content: Generated by Azure OpenAI LLM")
    print()
    
    try:
        # Import services
        from src.services.rich_message_service import RichMessageService
        from src.services.line_service import LineService
        from src.services.openai_service import OpenAIService
        from src.services.conversation_service import ConversationService
        from src.config.settings import Settings
        
        print("âœ… Services imported")
        
        # Initialize services
        settings = Settings()
        conversation_service = ConversationService()
        openai_service = OpenAIService(settings, conversation_service)
        line_service = LineService(settings, openai_service, conversation_service)
        line_bot_api = line_service.line_bot_api
        
        rich_service = RichMessageService(line_bot_api=line_bot_api)
        print("âœ… Services ready")
        
        # Check template
        template_path = "/home/runner/workspace/templates/rich_messages/backgrounds/productivity_focus_01.png"
        
        if not os.path.exists(template_path):
            print(f"âŒ Template not found: {template_path}")
            return False
        
        file_size = os.path.getsize(template_path)
        print(f"âœ… Template found: productivity_focus_01.png ({file_size:,} bytes)")
        
        # Generate content using LLM
        print("ğŸ¤– Generating productivity content with Azure OpenAI...")
        llm_response = generate_focus_content_with_llm(openai_service)
        
        if llm_response:
            print("âœ… LLM content generated")
            parsed_content = parse_llm_content(llm_response)
            
            if parsed_content:
                title = parsed_content['title']
                content = parsed_content['content']
                print(f"   ğŸ“ Title: {title}")
                print(f"   ğŸ’­ Preview: {content[:80]}...")
            else:
                print("âš ï¸ Failed to parse LLM content, using fallback")
                title = "ğŸ¯ Deep Focus Mode"
                content = llm_response
        else:
            print("âš ï¸ LLM generation failed, using fallback content")
            title = "ğŸ¯ Deep Focus Mode"
            content = "Focus is not about doing more things. It's about doing the right things with complete attention. Eliminate distractions, set clear intentions, and dive deep into your most important work. Your focus is your superpower - use it wisely today!"
        
        # Create Rich Message
        print("âœ… Creating Rich Message...")
        
        flex_message = rich_service.create_flex_message(
            title=title,
            content=content,
            image_path=template_path,
            content_id=f"productivity_llm_{int(datetime.now().timestamp())}",
            user_id=user_id,
            include_interactions=True
        )
        
        if not flex_message:
            print("âŒ Failed to create Rich Message")
            return False
        
        print("âœ… Rich Message created with LLM content")
        
        # Send the message
        print("ğŸ”´ SENDING...")
        line_bot_api.push_message(user_id, flex_message)
        print("ğŸ‰ Message sent successfully!")
        
        print()
        print("ğŸ“Š Message Details:")
        print(f"   ğŸ‘¤ Sent to: {user_id}")
        print(f"   ğŸ¨ Template: productivity_focus_01.png")
        print(f"   ğŸ­ Theme: Focused Productivity")
        print(f"   ğŸ¤– Content: Generated by Azure OpenAI LLM")
        print(f"   ğŸ“± Interactive: Like, Share, Save, React buttons")
        print(f"   ğŸ•’ Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print()
        print("ğŸ“± CHECK YOUR LINE APP!")
        print("   ğŸ¯ Look for the productivity-focused message")
        print("   ğŸ¤– Content created by AI based on focus/productivity themes")
        print("   ğŸ”˜ Try the interactive buttons:")
        print("      ğŸ’ Like - Show appreciation")
        print("      ğŸ“¤ Share - Spread productivity tips")  
        print("      ğŸ’¾ Save - Keep for reference")
        print("      ğŸ˜Š React - Add your response")
        
        # Show the generated content for reference
        print()
        print("ğŸ¤– Generated Content:")
        print(f"   Title: {title}")
        print(f"   Content: {content}")
        
        return True
        
    except Exception as e:
        print(f"âŒ Error: {str(e)}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    # User ID (keeping confidential)
    user_id = "U595491d702720bc7c90d50618324cac3"
    
    success = send_productivity_focus_message(user_id)
    
    print()
    if success:
        print("ğŸ‰ PRODUCTIVITY FOCUS MESSAGE SENT!")
        print("ğŸ“± Check your LINE app for the AI-generated productivity message!")
    else:
        print("âŒ Send failed")